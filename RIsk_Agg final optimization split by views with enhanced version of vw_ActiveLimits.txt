
CREATE OR ALTER VIEW vw_ActiveLimits AS
SELECT 
    memb_code,
    portfolio_limit_name AS limit_name,
    value,
    asof_dt,
    p_end_dt
FROM dbo.portfolio_limit
WHERE value <> 9999;

CREATE OR ALTER VIEW dbo.vw_PortfolioRiskFacts AS
SELECT
    arv.asof_dt,
    arv.CleanChoiceID,
    arv.calc_type,
    arv.spread_pc1,
    arv.spread_te,
    arv.curve_te,
    arv.curve_pc1,
    arv.curve_pc2,
    arv.tips_curve_te,
    arv.curve_te_with_tips,
    arv.curr_te,
    arv.emg_shock,
    arv.industry_te,
    arv.issuer_te,
    arv.total_te,
    arv.total_sys_te,
    arv.total_non_sys_te,
    arv.e_te,
    arv.e_pc1,
    arv.e_pc2,
    arv.e_pc3,
    arv.e_sp_te,
    arv.e_fx_te,
    arv.e_cv_te,
    arv.[e_sys te],
    arv.e_non_sys_te,
    arv.jpy_curve_pc1,
    arv.jpy_curve_pc2,
    acm.usd_mv,
    arv.STSR,
    arv.unified_curve_te,
    arv.unified_curr_te,
    arv.unified_spread_te,
    arv.unified_cmdty_te,
    arv.unified_vol_te,
    arv.unified_residual_te,
    arv.unified_tot_sys_te,
    arv.unified_industry_te,
    arv.unified_issuer_te,
    arv.unified_tot_non_sys_te,
    arv.unified_tot_te,
    arv.unified_curve_pc1,
    arv.unified_curve_pc2,
    arv.unified_mpc1,
    arv.unified_mpc1_rate,
    arv.unified_mpc1_curr,
    arv.unified_mpc1_sprd,
    arv.unified_empc1,
    arv.unified_empc1_rate,
    arv.unified_empc1_curr,
    arv.unified_empc1_sprd,
    arv.unified_non_sys_te,
    pl_Std.value AS Std_Flag,
    pl_Total.value AS Total_Threshold,
    pl_Syst.value AS Syst_Threshold,
    pl_FX.value AS FX_Threshold,
    pl_Spread.value AS Spread_Threshold,
    pl_Rates.value AS Rates_Threshold,
    pl_SPC1.value AS SPC1_Threshold,
    pgm.risk_mandate,
    pl_Budget.StdRiskBudget,
    pb.spc1_beta,
    pb.oldspdte_beta,
    pb.idxspdte_beta,
    pb.idxspc1_beta,
    pb.spdte_beta,
    pb.mpc1_beta
FROM dbo.vw_ActiveRiskValues arv
JOIN dbo.dn_portfolio_group_mandate pgm
  ON arv.CleanChoiceID = pgm.portfolio_name

-- Updated joins to ActiveLimits using time ranges
LEFT JOIN dbo.vw_ActiveLimits AS pl_Std
  ON arv.CleanChoiceID = pl_Std.memb_code 
     AND pl_Std.limit_name = 'StandardRiskBudget'
     AND pl_Std.asof_dt <= arv.asof_dt AND pl_Std.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_Total
  ON arv.CleanChoiceID = pl_Total.memb_code 
     AND pl_Total.limit_name = 'TotalTE'
     AND pl_Total.asof_dt <= arv.asof_dt AND pl_Total.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_Syst
  ON arv.CleanChoiceID = pl_Syst.memb_code 
     AND pl_Syst.limit_name = 'SystematicTE'
     AND pl_Syst.asof_dt <= arv.asof_dt AND pl_Syst.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_FX
  ON arv.CleanChoiceID = pl_FX.memb_code 
     AND pl_FX.limit_name = 'CurrencyTE'
     AND pl_FX.asof_dt <= arv.asof_dt AND pl_FX.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_Spread
  ON arv.CleanChoiceID = pl_Spread.memb_code 
     AND pl_Spread.limit_name = 'SpreadTE'
     AND pl_Spread.asof_dt <= arv.asof_dt AND pl_Spread.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_Rates
  ON arv.CleanChoiceID = pl_Rates.memb_code 
     AND pl_Rates.limit_name = 'CurveTE'
     AND pl_Rates.asof_dt <= arv.asof_dt AND pl_Rates.p_end_dt > arv.asof_dt

LEFT JOIN dbo.vw_ActiveLimits AS pl_SPC1
  ON arv.CleanChoiceID = pl_SPC1.memb_code 
     AND pl_SPC1.limit_name = 'SpreadPC1'
     AND pl_SPC1.asof_dt <= arv.asof_dt AND pl_SPC1.p_end_dt > arv.asof_dt

-- Keep budget and benchmark joins
LEFT JOIN dbo.vw_StdRiskBudget AS pl_Budget
  ON arv.CleanChoiceID = pl_Budget.memb_code

LEFT JOIN dbo.vw_ArmsCalcMV AS acm
  ON arv.CleanChoiceID = acm.choiceID 
     AND arv.asof_dt = acm.asof_dt

LEFT JOIN dbo.vw_PortBeta AS pb
  ON arv.CleanChoiceID = pb.choiceID 
     AND arv.asof_dt = pb.asof_dt

WHERE arv.asof_dt >= DATEADD(YEAR, -10, GETDATE())
  AND pgm.risk_mandate IS NOT NULL;
